---
title: "Lake-Characterization"
author: "Pablo Busch"
date: "`r format(Sys.time(),'%d-%m-%Y')`"
output:
  word_document:
    reference_doc: CLL_Template.docx
  html_document:
    theme: readable
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message=F)
knitr::opts_chunk$set(fig.pos = 'H', 
                      fig.width=12, fig.height=8,
                      message=F, echo = F, warning=F)
```

# Purpose

The main purpose of this document is to provide a characterization of the 23 lakes associated with Chile Lagos Limpios. The characterization will be done in the followings dimensiones:

- Physical attributes
- Demographics
- Socioeconomic


```{r, echo=F, message=F, warning=F}
# setwd("Scripts/Lake-Characterization") # only for debbuging without kniting
source("../00-Common.R", encoding = "UTF-8")
```


```{r, include=F}
source("01-LoadData-Boundaries-Physical.R", 
       encoding = "UTF-8")

# # Load Indicators
# physical_ind <- read_excel(url_file,"Physical Indicators",
#                            range = "B3:AD26")
# social_ind <- read_excel(url_file,"Social Indicators",
#                            range = "A3:N26")
# economic_ind <- read_excel(url_file,"Economic Indicators",
#                            range = "A3:W26")
# # Join all
# ind <- left_join(physical_ind,social_ind) %>% 
#   left_join(economic_ind)

ind <- physical_ind

```

# Location and administrative boundaries

The following map shows the location of the 23 lakes in the south of Chile. \newline

![Location of the 23 lakes](../../Figures/map.png)

## Administrative boundaries

The 23 lakes fall into different Chilean boundaries:

- 3 Regions - Araucania, Los Rios and Los Lagos
- 5 Provinces
- 14 communes (or counties)
- 12 cities (or urban settlements) are on the shore of 5 lakes. *Note: The city identification was made by using the district census 2017 for urban population.*

The following table presents the geographical classification of the 23 lakes (sorted by latitude). \newline

```{r}
ind %>% 
  left_join(cities_lakes) %>% 
  group_by(Region,Province,Commune,Lake,Latitude, City) %>% 
  summarise(count=n()) %>% 
  arrange(desc(Latitude)) %>% 
  flextable(col_keys = c("Region","Province","Commune","Lake", "City")) %>% 
  autofit(add_w = 0.1, add_h = 0.3) %>% 
  bold(j=4) %>% bold(part="header") %>% 
  merge_v(1:4) %>% border(border.bottom = fp_border())
```

# Physical Attributes

## 3.1	Lake Size - Area and Volume

Let's look at the area and volume of each lake (10 volume values for lakes are missing):

```{r}
library(ggforce)
# Ideas: https://stackoverflow.com/questions/45221783/ggforce-facet-zoom-labels-only-on-zoomed-example

# we need to create an additional data frame to show on the un-zoomed panel, but without the label
zoom_data <- ind %>% 
  filter(Area_km2<250, Volume_km3<30) %>% 
  mutate(Lake="",
         zoom=F)

# if zoom = T it shows on the zoom panel, if its equal to F it shows on the original panel
ind <- ind %>% mutate(zoom=(Area_km2<250 & Volume_km3<30))

tahoe$zoom <- F
ind %>% 
  rbind(zoom_data) %>%
  ggplot(aes(Area_km2,Volume_km3))+
  geom_point(aes(col=Region),size=3)+
  geom_text_repel(aes(label=Lake))+
  theme(legend.position="bottom")+
  xlab("Area [km2]")+ylab("Volumen [km3]")+
  labs(caption ="2 Lakes in Chile have a comparable size to Lake Tahoe. \n
       Volume data for 10 lakes is missing.")+
  geom_point(data=tahoe,col="black",size=3)+
  geom_text_repel(data=tahoe, aes(label=Name))+
  facet_zoom(zoom.data=zoom, 
             xlim = c(0, 250), ylim=c(0,30),
             zoom.size = 1.5)
rm(zoom_data)
```

We observe:

- Lago Ranco and Llanquihue are clear outliers in terms of size. Their total size is comparable to Lake Tahoe from California. \newline

## 3.2	Meteorological Conditions

We have also the data on how many meteorological stations exist in each lake:

```{r}
ind %>%
  filter(Meteorological_Stations>0) %>% 
  ggplot(aes(reorder(Lake,Latitude),
             Meteorological_Stations))+
  geom_col(aes(fill=Region))+
  coord_flip(expand = F)+
  labs(x="", y="# of Meteorological Stations", 
       caption="Note: Lakes without a meteorological station are ommited")
```


**TO DO**:

- Air temperature - average, max and min daily, days below freezing
- Annual and monthly precipitation
  - See: [TAHOE: STATE OF THE LAKE REPORT 202](https://www.notion.so/TAHOE-STATE-OF-THE-LAKE-REPORT-2020-a856f14c5d4a4b1fb96b03e7741f17c9)
- Air pollution
- Biota (?)
  - Species living in the zone


# Demography

## Population Characterization - Census 2017

More than half million people live in the 14 commune. Total population in the 14 communes is 558,798.

```{r}
source("Population.R",encoding = "UTF-8")
fig_pop
```

### Urban Population

In general, bigger communes have a greater share of urban population. \newline

The pattern in the communes of interest does not align with the national averages (88% urban and 12% rural).

```{r}
source("LoadData-Population.R", 
       encoding = "UTF-8")

# pop by commune and area
pop_commune <- pop_district %>% 
  group_by(COMUNA,AREA) %>%
  summarize(pop=sum(PERSONAS,na.rm=T)) %>% ungroup() %>% 
  left_join(cod_commune) %>% 
  filter(COMUNA %in% comunes_cll_codes) %>% 
  mutate(Urbano=factor(if_else(AREA==1,"Urbano","Rural"),
                       levels=c("Urbano","Rural")))
```


```{r, include=F}
# proportion urban-rural
# pop_district %>% 
#   group_by(AREA) %>% 
#   summarize(pop=sum(PERSONAS,na.rm=T)) %>% 
#   mutate(perc=pop/sum(pop))
# 
# codes_region <- codigos_territoriales %>% 
#   group_by(codigo_region,nombre_region) %>% tally()
# 
# pop_district %>% 
#   group_by(REGION,AREA) %>% 
#   summarize(pop=sum(PERSONAS,na.rm=T)) %>% 
#   mutate(perc=pop/sum(pop),
#          region=paste0(if_else(REGION>9,"","0"),REGION)) %>% 
#   left_join(codes_region,by=c("region"="codigo_region"))


# proportion urban-rural - excluding rm
# pop_district %>% 
#   filter(REGION!=13) %>% 
#   group_by(AREA) %>% 
#   summarize(pop=sum(PERSONAS,na.rm=T)) %>% 
#   mutate(perc=pop/sum(pop))
```


```{r}
# Calculate percentage
total_pop <- pop_commune %>% 
  group_by(COMUNA) %>% 
  mutate(total=sum(pop)/1000,
         perc=pop/sum(pop),
         perc_label=paste0(round(perc*100,0),"%"),
         NOM_COMUNA=str_to_title(NOM_COMUNA),
         name_label=paste0(NOM_COMUNA," (",round(total,0),"K)"))

total_pop %>% 
  ggplot(aes(reorder(name_label,total),perc))+
  geom_bar(aes(fill=forcats::fct_rev(Urbano)),
           position="stack", stat="identity")+
  labs(x="",y="Distribution of population [%]",fill="",
       caption="In parenthesis the total population of each commune is shown. Source: Census 2017")+
  geom_text(aes(label = perc_label), position = position_stack(vjust = 0.5))+
  coord_flip()+
  geom_hline(yintercept = 0.5,linetype="dashed")+
  scale_y_continuous(labels = scales::percent)+
   guides(fill = guide_legend(reverse=TRUE))+
  theme(legend.position="top")
# f_savePlot(last_plot(),"Figures/pop_urban.png")
```

### Population self-identified as belonging to an originary ethnic:

Around 11.9% of the national population identified themselves as belonging to an originary ethnic. \newline

The communes of interest shows a much higher proportion of 24.7%, with some communes with over 40% of their population belonging to an ethnic.

```{r}
# Calculate percentage
pop_commune <- pop_district %>% 
  group_by(COMUNA) %>%
  summarize(pop=sum(PERSONAS,na.rm=T),
            pop_etnic=sum(PUEBLO,na.rm=T)) %>% ungroup() %>% 
  left_join(cod_commune) %>% 
  filter(COMUNA %in% comunes_cll_codes) %>% 
  mutate(perc=pop_etnic/pop,
         NOM_COMUNA=str_to_title(NOM_COMUNA),
         name_label=paste0(NOM_COMUNA," (",round(pop/1000,0),"K)"))

# shape for plot
pop_commune <- pop_commune %>% 
  mutate(perc_nonEtnic=1-perc) %>% 
  pivot_longer(c(perc,perc_nonEtnic),
               names_to = "key",values_to="value") %>% 
  mutate(perc_label=paste0(round(value*100,0),"%"),
         etnic=if_else(key=="perc","Ethnic origin (self-identified)","Non-ethnic origin"))

pop_commune %>% 
  ggplot(aes(reorder(name_label,pop),value))+
  geom_bar(aes(fill=forcats::fct_rev(etnic)),
           position="stack", stat="identity")+
  labs(x="",y="Distribution of population [%]",fill="",
       caption="In parenthesis the total population of each commune is shown. Source: Census 2017")+
  geom_text(aes(label = perc_label), position = position_stack(vjust = 0.5))+
  coord_flip()+
  geom_hline(yintercept = 0.5,linetype="dashed")+
  scale_y_continuous(labels = scales::percent)+
   guides(fill = guide_legend(reverse=TRUE))+
  theme(legend.position="top")
# f_savePlot(last_plot(),"Figures/pop_Ethnic.png")


# national proportion
# pop_district %>% 
#   summarize(pop=sum(PERSONAS,na.rm=T),
#             etnic=sum(PUEBLO,na.rm=t)) %>% 
#   mutate(perc=etnic/pop)
# # communes of interest
# pop_district %>% 
#   filter(COMUNA %in% comunes_cll_codes) %>% 
#   summarize(pop=sum(PERSONAS,na.rm=T),
#             etnic=sum(PUEBLO,na.rm=t)) %>% 
#   mutate(perc=etnic/pop)
```


### Population at shores

We can see the population in cities that are directly on the shore of some lakes. We note the following interesting points:

- Only 5 lakes have a surrounding urban city in its shore.
- The total population in the shore of lakes is approx. 130 thousands.
- Lago Llanquihue and Villarica got the more cities and population in its shore.
- The analysis **does not** consider tourism nor rural population in the proximity of lakes.

```{r}
ind %>% 
  left_join(cities_lakes) %>% 
  filter(Pop_District_Census_2017>0) %>%
  mutate(pop=Pop_District_Census_2017/1000) %>% 
  ggplot(aes(x=reorder(City,Latitude),
             y=pop))+
  # geom_bar(position = position_dodge2(reverse=T),stat="identity")+
  geom_col(aes(fill=reorder(Lake,Latitude)))+
  scale_fill_viridis_d( guide = guide_legend(reverse = TRUE))+
  labs(x="",y="Urban Population 2017 [in thousands]",fill="",
       caption = "Source: District Census 2017")+
  geom_label(aes(label=round(pop,1)),nudge_y = 1)+
  coord_flip()+
  scale_y_continuous(expand = c(0, 0),limits=c(0,35))+
   theme(legend.position="left")
# f_savePlot(last_plot(),"Figures/cities_pop.png")
```


## Population Trends

Let's look at the population trend and projected for 2035, according to INE:

```{r}
pop_commune_cll %>% 
  mutate(pop=pop/1000,
         year=as.numeric(year),
         Nombre_Comuna=Nombre_Comuna %>%
           str_replace("Puc.n","Pucon") %>%
           str_replace("R.o","Rio")) %>% 
  left_join(map_commune) %>%
  ggplot(aes(year,pop,fill=reorder(Nombre_Comuna,desc(latitude_commune ))))+
  geom_area(alpha=.5,size=1, colour="black")+
  scale_fill_viridis_d()+
  labs(x="",fill="",y="Population [in thousands]",
       caption="Source: Census 2017 and INE")+
  geom_vline(xintercept = 2021, linetype="dashed")+
  annotate("text", x=2022,y=50, label="2021",angle = 90)+
  coord_cartesian(expand = F)
# f_savePlot(last_plot(),"Figures/proy_pop.png")
```

Population projects at this level of detail are not that much useful, as it misses potential changes in status quo such as:

- Migration from Santiago to the south of Chile
- International inmigration
- Urban growth in the zone

# Socioeconomic Analysis

## Casen Analysis - Socioeconomic characterization survey

### Income

Mean Income: Almost all communes show **mean income below national average**.

```{r}
source("casen_load.R",
       encoding = "UTF-8")
fig_income
```

Median Income:

```{r}
fig_income_med
```

### Education

The percetange of of people with less than high school education is higher than the national average for most of the communes in the zone.

```{r}
fig_education
```

### Health

Next is presented the percentageof population affiliated to each health provider. Note that:

- Isapre - Private provider
- FF.AA - Army health system
- Fonasa - Public Health system according to income level - A low to D high

```{r}
fig_health
```


## Tourism


```{r}
source("Tourism.R",encoding = "UTF-8")
```


**TO DO:**

- Number of visitors per year
- Other number of things, like: # of restaurants,# hotels, # of tourism attractions, ...


Key Questions:

- % tourism in total economic activity 
- PIB? Empleo por comuna?

## GDP Share per region

Main takeaways from the figure:

- Service sector - Lower than national level
- Agricultural - Higher than national level
- Manufacture Industry - Higher than national level

```{r}
fig_gdp
```


